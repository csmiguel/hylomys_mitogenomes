# Phylogenetic reconstruction of Hylomys based on mitochondrial genomes.
1. assembly.
    1. trim reads.
    2. build references.
    3. map to references.
    4. get consensus sequences.
2. phylogenetic reconstructions.
    1. trim and filter consensus
    2. annotate consensus
    3. multiple sequence alignment
    4. partition msa
    5. trim msa partitions
    6. removal of saturated partitions

## 1. Assembly of mitochondrial genomes
### 1.1. trim raw reads

[cutadapt](code/1.mito_cutadapt.sh) was run on all **Hylomys** [historical samples](output/seqmeta.xlsx), on paired end mode to trim Illumina adapters, and remove short reads <30nt.
The metadata for those samples is available at [metadata](output/seqmeta.xlsx).

### 1.2. build references

Paired, F and R reads were imported in Geneious Prime® 2023.0.4. 

A reference mitogenome was built for each of the taxa proposed in the manuscript (i.e. H. suillus, vorax, peguensis, maxi and macarong). This was done manually by mapping the PE reads iteratively to the published reference AM905041.1 (17290pb), using the Geneious mapper with Medium-Low sensitivity, and iterations up to 5 times. For each of the lineages, the sample with most mitochondrial reads (as previously determined by BWA mapping), was selected. From the alignments in Geneious, lineage-specific consensus sequences were generated. When coverage was below <2, bases from the reference were used in the consensus. All mappings were visually inspected.

For H. macarong, for which all samples had little coverage, a consensus sequence was generated from the mapping of the sequences from the 3 samples. For H. suillus, the NCBI AM905041.1 reference was used.

### 1.3. map to references

References were indexed with [BWA index](code/2.1.bwa-index-mito.sh).
[BWA mem](code/2.2.bwa-mem-mapped-sort-rmdup.sh) 0.7.17-r1188 mapped F and R reads from each sample to its lineage-specific reference with default parameters.
Unmapped reads were discarded from the SAM alignment files, sorted and PCR duplicates using samtools rmdup (version 1.16.1).
A [script in R](code/2.0.create-BWA-samtools-input.R) was used to generate the code for mapping and removing duplicates for all samples.
Same samples that came from different libraries were merged with samtools [script1](code/2.3.generate_samtools_merge_input.R)[script2](code/2.4.samtools_merge.sh).

### 1.4. get consensus sequences
The BAM alignments were imported into Geneious and consensus sequences were called for each sample using a threshold of at least 3x to call a base. Ambiguities (Ns) were introduced elsewhere with no coverage.

## 2. Phylogenetic analysis
### 2.1. trim and filter consensus
Trailing Ns, sequences with more than 70% of ambiguities and those bellow 10000 bp were removed using a custom [R script](code/3.clean_consensus_and_generate_inputML.sh).
The assembled sequences were combined into a multifasta with previously assembled mitogenomes.
The following message was generated by the script:
```
USNM320495 was droppped because it had 0.91 prop. of ambiguous nucleotides
THNHM03942 was droppped because it had 0.59 prop. of ambiguous nucleotides
THNHM03952 was droppped because it had 0.63 prop. of ambiguous nucleotides
USNM320500 was droppped because it had 0.45 prop. of ambiguous nucleotides
Neohylomys_hainanensis_MVZ186403 was droppped because it had 0.41 prop. of ambiguous nucleotides
Hylomys_suillus_peguensis_USNM583813 was droppped because it had 0.57 prop. of ambiguous nucleotides
Hylomys_suillus_dorsalis_BOR312 was droppped because it had 0.52 prop. of ambiguous nucleotides
Hylomys_suillus_dorsalis_BOR309 was droppped because it had 0.62 prop. of ambiguous nucleotides
Hylomys_suillus_dorsalis_BOR168 was droppped because it had 0.63 prop. of ambiguous nucleotides
```
A trimmed [multifasta with consensus](data/intermediate/clean_mitos.fasta) sequences for phylogenetic analysis was generated. It contained ingroups and outgroups. CSVs with nucloetide frequencies were written to [ouput](ouput).

### 2.2. annotate consensus
Clean mitochondrial sequences were imported to Geneious.
The annotated GenBank mitogenome AM905041 was used to transfer the annotations to the consensus sequences in Geneious.

### 2.3. multiple sequence alignment
Mafft v7.490 plugin in Geneious was used for multiple sequence alignment of the mitochondrial sequences. The alignment included 23 assembled mitogenomes from *Hylomys* sp., plus 2 *Hylomys* mitogenomes from GenBank (AM905041 and AM905042), _Neohylomys hainanensis_ MW429379 and NC063830, _Neotetracus sinensis_ NC019626, and _Echinosorex gymnura_ AF348079.
The alignment was edited manually to remove the control region. The transfered annotations were visually compared against the NCBI mitogenomes in the alignment and edited by hand where needed. Protein-coding genes were translated to aa and the frame was visually checked for each sample. In a few cases, insertions/deletions of Ns in the middle of the coding gene was altering the codon frame and introducing stop codons. In such cases, they were corrected by hand.

### 2.4. Partitioning of the MSA

The multiple sequence alignment was partition into the different genes according to the curated annotations. For protein coding genes, the 3 codon positions were written to different partitions. This was done with AMAS split.

```
conda activate base
part=path_to/data/intermediate/raxml/part_cleanal.txt
alig=path_to/data/intermediate/raxml/clean_edited.phy

conda activate

python3 /Applications/AMAS.py split \
    -f phylip -d dna \
    -i $alig \
    -l $part \
    -u fasta

conda deactivate
```
### 2.5. trim msa partitions

Gblocks was run on each partition using the windows of size 1 nt for column filtering and half of gapped positions. The resulting html files were inspected visually.

```
alpath=path_to/data/intermediate/raxml/
rm "$alpath"*out.fas-gb
rm "$alpath"*gb.htm
for alsplit in "$alpath"*out.fas
    do
    /Applications/Gblocks $alsplit -t=d -b5=h -b3=1 -b4=1 -b2=.51
    done
```

### 2.6. removal of saturated partitions

Raw genetic distance were plotted against Tamura and Nei (1993) corrected distances to evaluate the saturation of each partition, using a [script in R](code/4.saturation_plots.R). Distances were calculated using APE (Paradis and Schliep, 2019).
According to the saturation plots, codon position 3 of all protein-coding genes were saturated, and, therefore, they were removed. So, the selected partitions were copied to a new [folder](data/intermediate/raxml/run2_unsaturated).
These selected alignments were concatenated with AMAS.

```
/Applications/AMAS.py concat -i "$alpath"run2_unsaturated/*fas-gb -d dna -f fasta -u phylip \
 -p "$alpath"run2_unsaturated/partitions4PF_unsaturated.txt \
 -t "$alpath"run2_unsaturated/partitionFinder/contat4PF_unsaturated.phy
```

### 2.7 Partition scheme

The partition scheme for the phylogenetic analysis was determined with PartitionFinder 2.1.1, using unlinked branchlengths, GTR+G as the model of evolution, model selection based on AICc and the greedy search algorithm. See [config file](data/intermediate/raxml/run2_unsaturated/partitionFinder/partition_finder.cfg).

```
conda activate py27
python /Applications/partitionfinder-2.1.1/PartitionFinder.py \
"$alpath"run2_unsaturated/partitionfinder --raxml -p 4 --force-restart
```

### 2.8 ML phylogenetic inference

The best scheme was used as input to ML phylogenetic inference in RAxML 8.2.12. The rapid bootstrapping algorithm was run on RAxML using the model of evolution GTR+ Γ. It converged after 249 replicates following the automatic convergence criterion.

```
raxmlHPC-PTHREADS-SSE3 -f a -m GTRGAMMA -p 12345 -x 12345 -# autoMRE \
    -s "$alpath"run2_unsaturated/partitionFinder/contat4PF_unsaturated.phy -n tree -T2 \
    -w "$alpath"run2_unsaturated -q "$alpath"run2_unsaturated/part_raxml.txt
```

