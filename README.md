# Phylogenetic reconstruction of *Hylomys* based on mitochondrial genomes.
1. assembly.
    1. trim reads
    2. build references
    3. map to references
    4. get consensus sequences
2. multiple sequence alignment (MSA)
    1. trim and filter consensus
    2. annotate consensus
    3. MSA of high-coverage samples
    4. MSA of low-coverage samples
    5. partitioning of the MSA
    7. trim MSA partitions
    8. removal of saturated partitions
3. phylogenetic reconstruction
    1. Partition scheme
    2. ML phylogenetic inference

## 1. Assembly of mitochondrial genomes
### 1.1. trim raw reads

[cutadapt](code/1.mito_cutadapt.sh) was run on all *Hylomys* [historical samples](output/seqmeta.xlsx), on paired end mode to trim Illumina adapters, and remove short reads <30nt.
The metadata for those samples is available at [metadata](output/seqmeta.xlsx).

### 1.2. build references

Paired, F and R reads were imported in Geneious Prime® 2023.0.4. 

A reference mitogenome was built for each of the taxa proposed in the manuscript (i.e.*H. suillus, vorax, peguensis, maxi* and *macarong*). This was done manually by mapping the PE reads iteratively to the published reference AM905041.1 (17290pb), using the Geneious mapper with Medium-Low sensitivity, and up to 5 iterations. For each of the lineages, the sample with most mitochondrial reads (as previously determined by BWA mapping), was selected. From the alignments in Geneious, lineage-specific consensus sequences were generated. When coverage was below <2, bases from the reference were used in the consensus. All mappings were visually inspected.

For *H. macarong*, all samples had little coverage, thus a consensus sequence was generated from the mapping of the sequences from the 3 samples. For *H. suillus*, the NCBI AM905041.1 reference was used.

### 1.3. map to references

References were indexed with [BWA index](code/2.1.bwa-index-mito.sh).
[BWA mem](code/2.2.bwa-mem-mapped-sort-rmdup.sh) 0.7.17-r1188 mapped F and R reads from each sample to its lineage-specific reference with default parameters.
Unmapped reads were discarded from the SAM alignment files, sorted and PCR duplicates using samtools rmdup (version 1.16.1).
A [script in R](code/2.0.create-BWA-samtools-input.R) was used to generate the code for mapping with BWA and removing PCR duplicates with samtools for all samples.
Same samples that came from different libraries were merged with samtools [script1](code/2.3.generate_samtools_merge_input.R) [script2](code/2.4.samtools_merge.sh).

### 1.4. get consensus sequences
The BAM alignments were imported into Geneious and consensus sequences were called for each sample using a threshold of at least 3x to call a base. Ambiguities (Ns) were introduced elsewhere with no coverage.

## 2. multiple sequence alignment (MSA)
### 2.1. trim and filter consensus
Trailing Ns, sequences with more than 70% of ambiguities and those bellow 10000 bp were removed using a custom [R script](code/3.1.clean_consensus_and_generate_inputML.R).
The assembled sequences with medium/high coverage were combined into a multifasta with previously assembled mitogenomes.
The following message was generated by the script:
```
USNM320495 was droppped because it had 0.91 prop. of ambiguous nucleotides
THNHM03942 was droppped because it had 0.59 prop. of ambiguous nucleotides
THNHM03952 was droppped because it had 0.63 prop. of ambiguous nucleotides
USNM320500 was droppped because it had 0.45 prop. of ambiguous nucleotides
Neohylomys_hainanensis_MVZ186403 was droppped because it had 0.41 prop. of ambiguous nucleotides
Hylomys_suillus_peguensis_USNM583813 was droppped because it had 0.57 prop. of ambiguous nucleotides
Hylomys_suillus_dorsalis_BOR312 was droppped because it had 0.52 prop. of ambiguous nucleotides
Hylomys_suillus_dorsalis_BOR309 was droppped because it had 0.62 prop. of ambiguous nucleotides
Hylomys_suillus_dorsalis_BOR168 was droppped because it had 0.63 prop. of ambiguous nucleotides
```
A trimmed [multifasta with consensus](data/intermediate/consensus/clean_mitos.fasta) sequences for phylogenetic analysis was generated. It contained ingroups and outgroups. CSVs with nucloetide frequencies were written to [ouput](output).
In addition a list of [fasta sequences](data/intermediate/lowcov_consensus.fasta) was written with [R script](code/3.2.sel_lowcov_samples.R) with samples that did not pass the above quality filters, but which were valuable to be included in the phylogeny.

```
A,C,G,T,nonAmb,code
3318,1982,1198,3258,9756,Neohylomys_hainanensis_MVZ186403
2172,1304,832,2277,6585,Hylomys_suillus_peguensis_USNM583813
2246,1512,829,2374,6961,THNHM03942
1938,1385,765,2124,6212,THNHM03952
2987,2101,1249,3051,9388,USNM320500
```

### 2.2. annotate consensus
Clean mitochondrial sequences were imported to Geneious.
The annotated GenBank mitogenome AM905041 was used to transfer the annotations to the consensus sequences in Geneious.

### 2.3. MSA of high-coverage samples
Mafft v7.490 plugin in Geneious was used for multiple sequence alignment of the mitochondrial sequences with high coverage. The alignment included 23 assembled mitogenomes from *Hylomys* sp., plus 2 *Hylomys* mitogenomes from GenBank (AM905041 and AM905042), _Neohylomys hainanensis_ MW429379 and NC063830, _Neotetracus sinensis_ NC019626, and _Echinosorex gymnura_ AF348079.
The alignment was edited manually to remove the control region. The transfered annotations were visually compared against the NCBI mitogenomes in the alignment and edited by hand where needed. Protein-coding genes were translated to aa and the frame was visually checked for each sample. In a few cases, insertions/deletions of Ns in the middle of the coding gene was altering the codon frame and introducing stop codons. In such cases, they were corrected by hand. This is the core MSA.

### 2.4. MSA of low-coverage sample

Use `mafft --add` to add the low-quality samples to the pre-existing MSA.

```
inphy=data/intermediate/clean_edited.phy
infas=data/intermediate/clean_edited.fas
msaadded=data/intermediate/msa_added.fasta

/Applications/AMAS.py convert -i $inphy -d dna -f phylip -u fasta
# copy to target difr
outfas=$(ls *.fas)
mv $outfas $infas

conda activate base
mafft --add data/intermediate/lowcov_consensus.fasta --keeplength $infas > $msaadded
conda deactivate
```
### 2.5. partitioning of the MSA

The multiple sequence alignment was partitioned into the different genes according to the curated annotations. For protein coding genes, the 3 codon positions were written to different partitions. This was done with AMAS split.

```
part=data/intermediate/part_cleanal.txt
msaadded=data/intermediate/msa_added.fasta
inamas=data/intermediate/msa_added.phylip

/Applications/AMAS.py convert -i $msaadded -d dna -f fasta -u phylip
# copy to target difr
outphy=$(ls *.phy)
mv $outphy $inamas

conda activate
python3 /Applications/AMAS.py split \
    -f phylip -d dna \
    -i $inamas \
    -l $part \
    -u fasta

conda deactivate
```
### 2.6. trim msa partitions

Gblocks was run on each partition using a window of size 1 nt for column filtering and columns with up to half of gapped positions were considered. The resulting html files were inspected visually.

```
lowcov=data/intermediate/
rm "$lowcov"*out.fas-gb
rm "$lowcov"*gb.htm
for alsplit in "$lowcov"*out.fas
    do
    /Applications/Gblocks $alsplit -t=d -b5=h -b3=1 -b4=1 -b2=.51
    done
```
### 2.7. removal of saturated partitions

Raw genetic distances were plotted against Tamura and Nei (1993) corrected distances to evaluate the saturation of each partition, using a [script in R](code/4.saturation_plots.R). Distances were calculated using APE (Paradis and Schliep, 2019).

```
unsat=data/intermediate/unsaturated
mkdir $unsat
```
According to the saturation plots, codon position 3 of all protein-coding genes were saturated, and, therefore, they were removed. So, the selected partitions were copied to a new [folder](data/intermediate/unsaturated) with [this script](code/5.copy_fasta_nonSat_lowcov.R)
These selected alignments were concatenated with AMAS.

```
mkdir $unsat/partitionFinder
/Applications/AMAS.py concat -i "$unsat"/*fas-gb -d dna -f fasta -u phylip \
 -p "$unsat"/partitionFinder/partitions4PF_unsaturated.txt \
 -t "$unsat"/partitionFinder/contat4PF_unsaturated.phy
```
## 3. phylogenetic reconstruction
### 3.1. partition scheme

The partition scheme for the phylogenetic analysis was determined with PartitionFinder 2.1.1, using unlinked branchlengths, GTR+G as the model of evolution, model selection based on AICc and the greedy search algorithm. See [config file](data/intermediate/unsaturated/partitionFinder/partition_finder.cfg).

```
mkdir "$unsat"/partitionfinder
conda activate py27
python /Applications/partitionfinder-2.1.1/PartitionFinder.py \
"$unsat"/partitionfinder --raxml -p 2 --force-restart
```
### 3.2. ML phylogenetic inference

The [best scheme](data/intermediate/unsaturated/part_raxml.txt) was used as input to ML phylogenetic inference in RAxML 8.2.12. The rapid bootstrapping algorithm was run on RAxML using the model of evolution GTR+ Γ. It converged after 450 replicates following the automatic convergence criterion.

```
raxp=$(pwd)
raxmlHPC-PTHREADS-SSE3 -f a -m GTRGAMMA -p 12345 -x 12345 -# autoMRE \
    -s $raxp/$unsat/partitionFinder/contat4PF_unsaturated.phy -n tree -T2 \
    -w $raxp/$unsat -q "$unsat"/part_raxml.txt
```
